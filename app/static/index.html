<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MockMD</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      background: #f7f7f5;
      color: #1a1a1a;
      height: 100vh;
      display: flex;
      overflow: hidden;
    }

    /* â”€â”€ Main area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      height: 100vh;
      min-width: 0;
    }

    /* â”€â”€ Chat area (practice mode) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #chat-area {
      flex: 1;
      width: 100%;
      max-width: 760px;
      padding: 0 28px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      margin: 0 auto;
    }

    #chat-area::-webkit-scrollbar { width: 4px; }
    #chat-area::-webkit-scrollbar-thumb { background: #ddd; border-radius: 4px; }

    /* â”€â”€ Welcome screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #welcome {
      margin-top: auto;
      padding: 60px 0 32px;
    }

    #welcome h1 {
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: -0.5px;
      margin-bottom: 14px;
      line-height: 1.2;
    }

    #welcome h2 {
      font-size: 1.2rem;
      font-weight: 400;
      color: #222;
      margin-bottom: 14px;
    }

    #welcome p {
      font-size: 0.93rem;
      color: #666;
      font-style: italic;
      line-height: 1.5;
    }

    #welcome .source-link {
      font-size: 0.78rem;
      color: #aaa;
      font-style: normal;
      margin-top: 18px;
    }

    #welcome .source-link a { color: #8899bb; text-decoration: none; }
    #welcome .source-link a:hover { text-decoration: underline; }

    /* â”€â”€ Messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #messages { padding-bottom: 16px; }

    @keyframes msgIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .msg { margin-bottom: 22px; display: flex; animation: msgIn 0.22s ease-out; }

    .msg.user  { justify-content: flex-end; }
    .msg.ai    { justify-content: flex-start; }

    .msg.user .bubble {
      background: #e8e8e8;
      border-radius: 20px;
      padding: 11px 17px;
      max-width: 68%;
      font-size: 0.95rem;
      line-height: 1.5;
      color: #1a1a1a;
    }

    .msg.ai .bubble {
      max-width: 88%;
      font-size: 0.95rem;
      line-height: 1.65;
      color: #1a1a1a;
    }

    .msg.ai .bubble p       { margin-bottom: 10px; }
    .msg.ai .bubble p:last-child { margin-bottom: 0; }
    .msg.ai .bubble ul      { padding-left: 20px; margin-bottom: 10px; }
    .msg.ai .bubble ol      { padding-left: 20px; margin-bottom: 10px; }
    .msg.ai .bubble li      { margin-bottom: 4px; }

    .inline-img {
      display: block;
      max-width: 280px;
      border-radius: 10px;
      margin-top: 14px;
      border: 1px solid #e0e0e0;
    }

    /* â”€â”€ Loading dots â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .loading-row {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #777;
      font-size: 0.9rem;
    }

    .dots { display: flex; gap: 5px; }

    .dot {
      width: 9px; height: 9px;
      border-radius: 50%;
      animation: pulse 1.3s infinite ease-in-out;
    }
    .dot:nth-child(1) { background: #c0c0c0; animation-delay: 0s; }
    .dot:nth-child(2) { background: #999;    animation-delay: 0.18s; }
    .dot:nth-child(3) { background: #555;    animation-delay: 0.36s; }

    @keyframes pulse {
      0%, 80%, 100% { transform: scale(0.75); opacity: 0.5; }
      40%            { transform: scale(1);    opacity: 1; }
    }

    /* â”€â”€ Study similar button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-similar {
      display: inline-block;
      margin-top: 12px;
      padding: 10px 22px;
      background: #7b8db0;
      color: #fff;
      border: none;
      border-radius: 24px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-similar:hover { background: #6a7da0; }

    /* â”€â”€ Input area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #input-area {
      width: 100%;
      max-width: 760px;
      padding: 12px 28px 8px;
      margin: 0 auto;
    }

    #input-row {
      display: flex;
      align-items: flex-end;
      background: #fff;
      border: 1.5px solid #e2e2e2;
      border-radius: 26px;
      padding: 10px 10px 10px 16px;
      gap: 8px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.06);
    }

    #msg-input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 0.95rem;
      font-family: inherit;
      resize: none;
      max-height: 130px;
      background: transparent;
      line-height: 1.45;
      color: #1a1a1a;
    }

    #msg-input::placeholder { color: #aaa; }

    #upload-label {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px; height: 28px;
      cursor: pointer;
      color: #bbb;
      flex-shrink: 0;
      border-radius: 50%;
      transition: color 0.2s, background 0.2s;
    }
    #upload-label:hover { color: #777; background: #f0f0f0; }
    #upload-label svg { width: 16px; height: 16px; }

    #send-btn {
      width: 28px; height: 28px;
      border-radius: 50%;
      background: #4a4a4a;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.2s;
    }
    #send-btn:hover { background: #222; }
    #send-btn:disabled { background: #ccc; cursor: default; }
    #send-btn svg { width: 12px; height: 12px; fill: #fff; }

    /* â”€â”€ Mode nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #mode-nav {
      width: 100%;
      max-width: 760px;
      margin: 0 auto;
      padding: 6px 28px 16px;
      display: flex;
      gap: 4px;
    }

    .mode-tab {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 0;
      border: none;
      background: none;
      border-radius: 12px;
      font-size: 0.82rem;
      font-weight: 500;
      color: #aaa;
      cursor: pointer;
      transition: color 0.18s, background 0.18s;
      font-family: inherit;
    }
    .mode-tab svg { width: 15px; height: 15px; }
    .mode-tab:hover { color: #555; background: #efefed; }
    .mode-tab.active { color: #1a1a1a; background: #ebebea; }

    /* â”€â”€ Finder area (find cases mode) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #finder-area {
      display: none;
      flex: 1;
      flex-direction: column;
      overflow: hidden;
      width: 100%;
      max-width: 760px;
      margin: 0 auto;
      padding: 24px 28px 0;
    }

    #finder-area.visible { display: flex; }

    #finder-search-row {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
    }

    #finder-query {
      flex: 1;
      padding: 11px 18px;
      border: 1.5px solid #e2e2e2;
      border-radius: 22px;
      font-size: 0.93rem;
      font-family: inherit;
      background: #fff;
      outline: none;
      color: #1a1a1a;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }
    #finder-query::placeholder { color: #aaa; }
    #finder-query:focus { border-color: #c0c8d8; }

    #finder-search-btn {
      padding: 11px 20px;
      background: #4a4a4a;
      color: #fff;
      border: none;
      border-radius: 22px;
      font-size: 0.88rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.2s;
      white-space: nowrap;
    }
    #finder-search-btn:hover { background: #222; }
    #finder-search-btn:disabled { background: #ccc; cursor: default; }

    #finder-dropzone {
      border: 2px dashed #d8d8d8;
      border-radius: 14px;
      padding: 20px;
      text-align: center;
      font-size: 0.85rem;
      color: #aaa;
      cursor: pointer;
      transition: border-color 0.18s, background 0.18s, color 0.18s;
      margin-bottom: 18px;
    }
    #finder-dropzone:hover, #finder-dropzone.drag-over {
      border-color: #7b8db0;
      background: #f0f3f8;
      color: #7b8db0;
    }
    #finder-dropzone svg { width: 22px; height: 22px; margin-bottom: 6px; opacity: 0.5; }

    #finder-status {
      font-size: 0.8rem;
      color: #888;
      margin-bottom: 10px;
      min-height: 18px;
      font-style: italic;
    }

    #finder-results {
      flex: 1;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      align-content: start;
      padding-bottom: 12px;
    }

    #finder-results::-webkit-scrollbar { width: 3px; }
    #finder-results::-webkit-scrollbar-thumb { background: #ddd; border-radius: 3px; }

    .case-card {
      background: #fff;
      border-radius: 14px;
      padding: 14px 16px 12px;
      border: 1px solid #ebebeb;
      display: flex;
      flex-direction: column;
      gap: 6px;
      animation: msgIn 0.22s ease-out;
    }

    .case-card-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: #1a1a1a;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .case-card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .tag {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 10px;
      background: #f0f0ee;
      color: #666;
      font-weight: 500;
    }
    .tag.specialty { background: #e8eef6; color: #5a7aaa; }
    .tag.difficulty-beginner { background: #e8f5ec; color: #4a9a5a; }
    .tag.difficulty-intermediate { background: #fff3e0; color: #b07a20; }
    .tag.difficulty-advanced { background: #fde8e8; color: #b04040; }

    .case-card-complaint {
      font-size: 0.78rem;
      color: #777;
      font-style: italic;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .score-bar-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 2px;
    }

    .score-bar-track {
      flex: 1;
      height: 4px;
      background: #efefed;
      border-radius: 2px;
      overflow: hidden;
    }

    .score-bar-fill {
      height: 100%;
      border-radius: 2px;
      background: linear-gradient(90deg, #7b8db0, #a0bcd8);
      transition: width 0.5s ease;
    }

    .score-label {
      font-size: 0.72rem;
      color: #aaa;
      font-weight: 500;
      width: 32px;
      text-align: right;
    }

    .btn-start-case {
      margin-top: 4px;
      padding: 7px 0;
      background: #f0f3f8;
      color: #5a7aaa;
      border: none;
      border-radius: 10px;
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.18s;
      width: 100%;
    }
    .btn-start-case:hover { background: #e0e8f4; }

    /* â”€â”€ Drag overlay (whole-app drag-drop in practice mode) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #drag-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(123,141,176,0.15);
      backdrop-filter: blur(2px);
      z-index: 100;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    #drag-overlay.active { display: flex; }

    #drag-overlay-inner {
      background: #fff;
      border: 2px dashed #7b8db0;
      border-radius: 20px;
      padding: 40px 60px;
      text-align: center;
      color: #7b8db0;
      font-size: 1rem;
      font-weight: 500;
    }
    #drag-overlay-inner svg { width: 36px; height: 36px; margin-bottom: 12px; }

    /* â”€â”€ Right panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #right-panel {
      width: 0;
      min-width: 0;
      height: 100vh;
      background: #fff;
      border-left: 0px solid #ebebeb;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: width 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                  border-left-width 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                  min-width 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #right-panel.visible {
      width: 320px;
      min-width: 320px;
      border-left-width: 1px;
    }

    #panel-header {
      padding: 22px 20px 14px;
      border-bottom: 1px solid #f2f2f2;
      min-width: 320px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #panel-header h3 {
      font-size: 1rem;
      font-weight: 600;
      color: #1a1a1a;
      flex: 1;
    }

    #panel-spinner {
      display: none;
      width: 14px; height: 14px;
      border: 2px solid #e0e0e0;
      border-top-color: #7b8db0;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    #panel-content {
      flex: 1;
      min-width: 320px;
      overflow-y: auto;
    }

    #panel-content::-webkit-scrollbar { width: 3px; }
    #panel-content::-webkit-scrollbar-thumb { background: #e0e0e0; border-radius: 3px; }

    /* â”€â”€ Accordion sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section { border-bottom: 1px solid #f4f4f4; }

    .section-hdr {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 13px 18px;
      cursor: pointer;
      user-select: none;
      font-size: 0.88rem;
      font-weight: 600;
      color: #1a1a1a;
    }

    .arrow {
      font-size: 0.65rem;
      color: #888;
      transition: transform 0.18s;
      line-height: 1;
    }

    .section.open .arrow { transform: rotate(90deg); }

    .section-body {
      display: none;
      padding: 2px 18px 14px;
      font-size: 0.83rem;
      line-height: 1.6;
      color: #444;
    }

    .section.open .section-body { display: block; }

    .row { margin-bottom: 4px; }

    .test-entry {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .test-thumb {
      width: 48px; height: 48px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #eee;
    }

    .panel-img {
      display: block;
      width: 100%;
      border-radius: 8px;
      margin: 8px 0 6px;
      border: 1px solid #e8e8e8;
      cursor: zoom-in;
    }

    .empty-note {
      color: #bbb;
      font-style: italic;
      font-size: 0.82rem;
    }

    /* â”€â”€ Panel action buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #panel-actions {
      padding: 14px 16px;
      min-width: 320px;
      display: flex;
      gap: 10px;
      border-top: 1px solid #f2f2f2;
    }

    .btn-end {
      flex: 1;
      padding: 11px 8px;
      border-radius: 24px;
      border: none;
      background: #7b8db0;
      color: #fff;
      font-size: 0.83rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-end:hover { background: #6a7da0; }

    .btn-skip {
      flex: 1;
      padding: 11px 8px;
      border-radius: 24px;
      border: none;
      background: #d4898a;
      color: #fff;
      font-size: 0.83rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-skip:hover { background: #c07879; }

    /* â”€â”€ Login modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #login-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(247,247,245,0.85);
      backdrop-filter: blur(4px);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }
    #login-overlay.visible { display: flex; }

    #login-box {
      background: #fff;
      border-radius: 18px;
      padding: 44px 40px;
      width: 360px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.12);
    }

    #login-box h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 30px;
    }

    .field { margin-bottom: 18px; }
    .field label {
      display: block;
      font-size: 0.88rem;
      margin-bottom: 7px;
      color: #444;
      font-weight: 500;
    }
    .field input {
      width: 100%;
      padding: 12px 14px;
      border: none;
      border-radius: 10px;
      background: #f0f0f0;
      font-size: 0.93rem;
      font-family: inherit;
      outline: none;
      color: #1a1a1a;
    }
    .field input:focus { background: #e8e8e8; }

    #login-submit {
      width: 100%;
      padding: 14px;
      background: #7b8db0;
      color: #fff;
      border: none;
      border-radius: 24px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      margin-top: 6px;
      transition: background 0.2s;
    }
    #login-submit:hover { background: #6a7da0; }

    #login-error {
      color: #c0392b;
      font-size: 0.83rem;
      margin-top: 10px;
      display: none;
      text-align: center;
    }
  </style>
</head>
<body>

<!-- â”€â”€ Login modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="login-overlay">
  <div id="login-box">
    <h2>Login</h2>
    <div class="field">
      <label>Password</label>
      <input type="password" id="login-password" placeholder="" autofocus>
    </div>
    <button id="login-submit">Login</button>
    <p id="login-error">Incorrect password. Please try again.</p>
  </div>
</div>

<!-- â”€â”€ Drag overlay (practice mode image drop) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="drag-overlay">
  <div id="drag-overlay-inner">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M4 16l4-4 4 4 4-8 4 4"/>
      <rect x="3" y="3" width="18" height="18" rx="2"/>
    </svg>
    <div>Drop medical image to find similar cases</div>
  </div>
</div>

<!-- â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="main">

  <!-- Practice mode -->
  <div id="chat-area">
    <div id="welcome">
      <h1>Welcome to MockMD.</h1>
      <h2>What type of case would you like to study?</h2>
      <p>Describe a case in natural language, or switch to Find Cases to browse by image or keyword.</p>
      <p class="source-link">Cases sourced from the
        <a href="https://github.com/mauro-nievoff/MultiCaRe_Dataset" target="_blank" rel="noopener">
          MultiCaRe Dataset
        </a> â€” 72,000+ real PubMed Central case reports.
      </p>
    </div>
    <div id="messages"></div>
  </div>

  <div id="input-area">
    <div id="input-row">
      <label id="upload-label" title="Upload medical image">
        <input type="file" id="img-file" accept="image/*" style="display:none">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/>
        </svg>
      </label>
      <textarea id="msg-input" rows="1"
        placeholder="Describe what you'd like to practiceâ€¦"></textarea>
      <button id="send-btn" title="Send">
        <svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>

  <!-- Find Cases mode -->
  <div id="finder-area">
    <div id="finder-search-row">
      <input type="text" id="finder-query"
        placeholder="Search by condition, symptom, specialty, imaging typeâ€¦">
      <button id="finder-search-btn" onclick="runTextSearch()">Search</button>
    </div>

    <div id="finder-dropzone" onclick="document.getElementById('finder-file').click()">
      <input type="file" id="finder-file" accept="image/*" style="display:none">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <rect x="3" y="3" width="18" height="18" rx="2"/>
        <circle cx="8.5" cy="8.5" r="1.5"/>
        <path d="M21 15l-5-5L5 21"/>
      </svg>
      <div>Drop a medical image here, or click to upload</div>
      <div style="font-size:0.72rem;margin-top:4px;opacity:0.7">
        Find cases with similar imaging
      </div>
    </div>

    <div id="finder-status"></div>
    <div id="finder-results"></div>
  </div>

  <!-- Mode nav -->
  <div id="mode-nav">
    <button id="tab-practice" class="mode-tab active" onclick="setMode('practice')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
      </svg>
      Practice
    </button>
    <button id="tab-finder" class="mode-tab" onclick="setMode('finder')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
      </svg>
      Find Cases
    </button>
  </div>

</div>

<!-- â”€â”€ Right panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="right-panel">
  <div id="panel-header">
    <h3>Case Overview</h3>
    <div id="panel-spinner"></div>
  </div>
  <div id="panel-content"></div>
  <div id="panel-actions">
    <button class="btn-end"  onclick="endDiagnosis()">End &amp; Review</button>
    <button class="btn-skip" onclick="skipCase()">Skip Case</button>
  </div>
</div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const S = {
  sessionId:  getOrCreateSession(),
  activeCase: null,
  revealed:   {},
  complete:   false,
  busy:       false,
  mode:       'practice',
};

function getOrCreateSession() {
  let id = localStorage.getItem('medcase_sid');
  if (!id) { id = crypto.randomUUID(); localStorage.setItem('medcase_sid', id); }
  return id;
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function boot() {
  const r    = await fetch('/api/auth-required');
  const data = await r.json();
  if (data.required && !sessionStorage.getItem('medcase_auth')) {
    showLogin();
  }
})();

// â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLogin() {
  document.getElementById('login-overlay').classList.add('visible');
}

document.getElementById('login-submit').addEventListener('click', doLogin);
document.getElementById('login-password').addEventListener('keydown', e => {
  if (e.key === 'Enter') doLogin();
});

async function doLogin() {
  const pw  = document.getElementById('login-password').value;
  const err = document.getElementById('login-error');
  err.style.display = 'none';

  const r = await fetch('/api/login', {
    method:  'POST',
    headers: {'Content-Type': 'application/json'},
    body:    JSON.stringify({ password: pw }),
  });

  if (r.ok) {
    sessionStorage.setItem('medcase_auth', '1');
    document.getElementById('login-overlay').classList.remove('visible');
  } else {
    err.style.display = 'block';
  }
}

// â”€â”€ Mode switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setMode(mode) {
  S.mode = mode;
  const isPractice = mode === 'practice';

  document.getElementById('chat-area').style.display   = isPractice ? '' : 'none';
  document.getElementById('input-area').style.display  = isPractice ? '' : 'none';
  document.getElementById('finder-area').classList.toggle('visible', !isPractice);
  document.getElementById('tab-practice').classList.toggle('active', isPractice);
  document.getElementById('tab-finder').classList.toggle('active', !isPractice);

  if (!isPractice) {
    document.getElementById('finder-query').focus();
  } else {
    inputEl.focus();
  }
}

// â”€â”€ Input handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const inputEl = document.getElementById('msg-input');
const sendBtn = document.getElementById('send-btn');

inputEl.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
});
inputEl.addEventListener('input', () => {
  inputEl.style.height = 'auto';
  inputEl.style.height = Math.min(inputEl.scrollHeight, 130) + 'px';
});
sendBtn.addEventListener('click', send);

// File upload via paperclip
document.getElementById('img-file').addEventListener('change', e => {
  const file = e.target.files[0];
  if (file) handleImageUpload(file, 'practice');
  e.target.value = '';
});

document.getElementById('finder-file').addEventListener('change', e => {
  const file = e.target.files[0];
  if (file) handleImageUpload(file, 'finder');
  e.target.value = '';
});

// Finder search on Enter
document.getElementById('finder-query').addEventListener('keydown', e => {
  if (e.key === 'Enter') runTextSearch();
});

// â”€â”€ Core send â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function send(overrideText) {
  const text = (overrideText ?? inputEl.value).trim();
  if (!text || S.busy) return;

  if (!overrideText) {
    inputEl.value = '';
    inputEl.style.height = 'auto';
  }

  appendMsg('user', text);
  hideWelcome();

  const loadingText = S.activeCase ? '' : 'Searching 72,000 PubMed casesâ€¦';
  const loadId      = appendLoading(loadingText);

  S.busy = true;
  sendBtn.disabled = true;

  try {
    const r    = await fetch('/api/chat', {
      method:  'POST',
      headers: {'Content-Type': 'application/json'},
      body:    JSON.stringify({ session_id: S.sessionId, message: text }),
    });
    const data = await r.json();

    removeLoading(loadId);

    if (data.detail) {
      appendMsg('ai', 'âš ï¸ ' + data.detail);
    } else {
      appendMsg('ai', data.response, data.image_url);

      if (data.case) {
        S.activeCase = data.case;
        if (!document.getElementById('right-panel').classList.contains('visible')) {
          showPanel();
        }
      }

      // Keep client-side revealed state in sync so panel can use it
      if (data.revealed !== undefined) S.revealed = data.revealed;

      if (data.complete && !S.complete) {
        S.complete = true;
        appendSimilarBtn();
        document.getElementById('panel-actions').style.display = 'none';
      }

      if (S.activeCase) refreshPanelFromHistory();
    }
  } catch (err) {
    removeLoading(loadId);
    appendMsg('ai', 'Something went wrong. Please try again.');
  }

  S.busy = false;
  sendBtn.disabled = false;
  inputEl.focus();
}

// â”€â”€ Message rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hideWelcome() {
  document.getElementById('welcome').style.display = 'none';
}

function appendMsg(role, text, imageUrl) {
  const wrap   = document.createElement('div');
  wrap.className = `msg ${role}`;

  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.innerHTML = mdToHtml(text);

  if (imageUrl) {
    const img = document.createElement('img');
    img.src       = imageUrl;
    img.className = 'inline-img';
    img.alt       = 'Medical imaging';
    bubble.appendChild(img);
  }

  wrap.appendChild(bubble);
  document.getElementById('messages').appendChild(wrap);

  // Scroll so the TOP of new AI messages is visible; user messages go to bottom
  if (role === 'ai') {
    const area = document.getElementById('chat-area');
    // Small delay lets the element render before measuring
    requestAnimationFrame(() => {
      const msgTop = wrap.offsetTop - 12;
      const visibleBottom = area.scrollTop + area.clientHeight;
      if (msgTop > visibleBottom - 60) {
        area.scrollTo({ top: msgTop, behavior: 'smooth' });
      } else {
        area.scrollTop = area.scrollHeight;
      }
    });
  } else {
    scrollBottom();
  }
}

function appendLoading(label) {
  const id   = 'ld-' + Date.now();
  const wrap = document.createElement('div');
  wrap.id        = id;
  wrap.className = 'msg ai';
  wrap.innerHTML = `<div class="bubble">
    <div class="loading-row">
      <div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
      ${label ? `<span>${label}</span>` : ''}
    </div>
  </div>`;
  document.getElementById('messages').appendChild(wrap);
  scrollBottom();
  return id;
}

function removeLoading(id) {
  document.getElementById(id)?.remove();
}

function appendSimilarBtn() {
  const wrap = document.createElement('div');
  wrap.className = 'msg ai';
  wrap.innerHTML = `<div class="bubble">
    <p>What type of case would you like to study next?</p>
    <button class="btn-similar" onclick="studySimilar()">Study A Similar Case</button>
  </div>`;
  document.getElementById('messages').appendChild(wrap);
  scrollBottom();
}

function scrollBottom() {
  const a = document.getElementById('chat-area');
  a.scrollTop = a.scrollHeight;
}

// â”€â”€ Markdown â†’ HTML (minimal) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mdToHtml(text) {
  if (!text) return '';

  const escaped = text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');

  return escaped
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/âœ…/g, '<span style="color:#27ae60">âœ…</span>')
    .replace(/âš ï¸/g,  '<span style="color:#e67e22">âš ï¸</span>')
    .replace(/âŒ/g,  '<span style="color:#e74c3c">âŒ</span>')
    .replace(/ğŸ“š/g,  '<strong>ğŸ“š</strong>')
    .replace(/(?:^|\n)(\d+)\. (.+)/g, (_, n, t) => `\n<li>${t}</li>`)
    .replace(/(?:^|\n)[â€¢\-] (.+)/g, (_, t) => `\n<li>${t}</li>`)
    .replace(/(<li>.*<\/li>\n?)+/gs, m => `<ul>${m}</ul>`)
    .replace(/\n{2,}/g, '</p><p>')
    .replace(/\n/g, '<br>')
    .replace(/^/, '<p>')
    .replace(/$/, '</p>');
}

// â”€â”€ Right panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPanel() {
  document.getElementById('right-panel').classList.add('visible');
  document.getElementById('panel-actions').style.display = 'flex';
  document.getElementById('panel-content').innerHTML = `
    <div style="padding:18px;color:#bbb;font-size:0.85rem;font-style:italic">
      Reading caseâ€¦
    </div>`;
}

async function refreshPanelFromHistory() {
  const spinner = document.getElementById('panel-spinner');
  if (spinner) spinner.style.display = 'block';
  try {
    const r    = await fetch('/api/panel-update', {
      method:  'POST',
      headers: {'Content-Type': 'application/json'},
      body:    JSON.stringify({ session_id: S.sessionId }),
    });
    const data = await r.json();
    if (data.panel) {
      const panel = data.panel;
      // If imaging has been revealed but Gemini missed it in the transcript,
      // inject it directly from the server-tracked revealed state.
      if (S.revealed && S.revealed.imaging && (!panel.imaging || panel.imaging.length === 0)) {
        panel.imaging = [{
          type:     S.revealed.imaging.type || (S.activeCase && S.activeCase.imaging_type) || 'Imaging',
          findings: S.revealed.imaging.description || '',
        }];
      }
      renderPanel(panel);
    }
  } catch (e) {
    // silently fail â€” panel is non-critical
  } finally {
    if (spinner) spinner.style.display = 'none';
  }
}

function renderPanel(p) {
  let vitalsHtml = '';
  if (p.patient_name) vitalsHtml += `<div class="row"><strong>Name:</strong> ${escHtml(p.patient_name)}</div>`;
  if (p.sex)          vitalsHtml += `<div class="row"><strong>Sex:</strong> ${escHtml(p.sex)}</div>`;
  if (p.age)          vitalsHtml += `<div class="row"><strong>Age:</strong> ${escHtml(String(p.age))}</div>`;

  const vs = p.vital_signs || {};
  if (vs.blood_pressure)    vitalsHtml += `<div class="row"><strong>Blood Pressure:</strong> ${escHtml(vs.blood_pressure)}</div>`;
  if (vs.heart_rate)        vitalsHtml += `<div class="row"><strong>Heart Rate:</strong> ${escHtml(vs.heart_rate)}</div>`;
  if (vs.temperature)       vitalsHtml += `<div class="row"><strong>Temperature:</strong> ${escHtml(vs.temperature)}</div>`;
  if (vs.oxygen_saturation) vitalsHtml += `<div class="row"><strong>SpOâ‚‚:</strong> ${escHtml(vs.oxygen_saturation)}</div>`;
  if (vs.respiratory_rate)  vitalsHtml += `<div class="row"><strong>Resp Rate:</strong> ${escHtml(vs.respiratory_rate)}</div>`;
  if (!vitalsHtml) vitalsHtml = '<p class="empty-note">Not yet reported.</p>';

  const symptoms = p.symptoms || [];
  const symptomsHtml = symptoms.length
    ? symptoms.map(s => `<div class="row">â€¢ ${escHtml(s)}</div>`).join('')
    : `<p class="empty-note">${escHtml(p.chief_complaint || 'Not yet reported.')}</p>`;

  const tests   = p.tests   || [];
  const imaging = p.imaging || [];
  let testsHtml = '';

  for (const t of tests) {
    testsHtml += `
      <div style="margin-bottom:12px">
        <div style="font-weight:600;font-size:0.84rem;margin-bottom:3px">${escHtml(t.name)}</div>
        <div style="font-size:0.8rem;color:#555;line-height:1.5">${escHtml(t.result)}</div>
      </div>`;
  }
  for (const img of imaging) {
    const imgHtml = S.activeCase
      ? `<img src="/api/image/${S.activeCase.id}" class="panel-img" alt="${escHtml(img.type)}"
           onclick="window.open(this.src,'_blank')"
           onerror="this.style.display='none'">`
      : '';
    testsHtml += `
      <div style="margin-bottom:14px">
        <div style="font-weight:600;font-size:0.84rem">${escHtml(img.type)}</div>
        ${imgHtml}
        <div style="font-size:0.8rem;color:#555;line-height:1.5;margin-top:4px">${escHtml(img.findings)}</div>
      </div>`;
  }
  if (!testsHtml) testsHtml = '<p class="empty-note">No tests ordered yet.</p>';

  const historyHtml = p.history
    ? `<div style="font-size:0.83rem;line-height:1.6">${escHtml(p.history)}</div>`
    : '<p class="empty-note">Not yet reported.</p>';

  const hasTests = tests.length > 0 || imaging.length > 0;

  const sections = [
    { title: 'Vital Signs',     open: true,     html: vitalsHtml },
    { title: 'Symptoms',        open: true,     html: symptomsHtml },
    { title: 'Tests & Results', open: hasTests, html: testsHtml },
    { title: 'Patient History', open: false,    html: historyHtml },
  ];

  const existing = {};
  document.querySelectorAll('#panel-content .section').forEach(el => {
    const title = el.querySelector('.section-hdr span:last-child')?.textContent;
    if (title) existing[title] = el.classList.contains('open');
  });

  document.getElementById('panel-content').innerHTML = sections.map(s => {
    const isOpen = (s.title in existing) ? existing[s.title] : s.open;
    return `
      <div class="section ${isOpen ? 'open' : ''}">
        <div class="section-hdr" onclick="toggleSection(this.parentElement)">
          <span class="arrow">â–¶</span>
          <span>${s.title}</span>
        </div>
        <div class="section-body">${s.html}</div>
      </div>`;
  }).join('');
}

function toggleSection(el) { el.classList.toggle('open'); }

// â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function endDiagnosis() {
  send("Please evaluate my performance on this case and provide key learning points.");
}

async function skipCase() {
  await fetch('/api/new-case', {
    method:  'POST',
    headers: {'Content-Type': 'application/json'},
    body:    JSON.stringify({ session_id: S.sessionId }),
  });
  resetUI();
}

async function studySimilar() {
  hideWelcome();
  const loadId = appendLoading('Finding a similar caseâ€¦');

  try {
    const r    = await fetch('/api/similar-case', {
      method:  'POST',
      headers: {'Content-Type': 'application/json'},
      body:    JSON.stringify({ session_id: S.sessionId }),
    });
    const data = await r.json();

    removeLoading(loadId);

    S.activeCase = data.case;
    S.revealed   = {};
    S.complete   = false;

    appendMsg('ai', data.response, data.image_url);
    showPanel();
    document.getElementById('panel-actions').style.display = 'flex';
    refreshPanelFromHistory();
  } catch (err) {
    removeLoading(loadId);
    appendMsg('ai', 'Something went wrong. Please try again.');
  }
}

function resetUI() {
  S.activeCase = null;
  S.revealed   = {};
  S.complete   = false;
  document.getElementById('messages').innerHTML      = '';
  document.getElementById('panel-content').innerHTML = '';
  document.getElementById('right-panel').classList.remove('visible');
  document.getElementById('welcome').style.display   = 'block';
  document.getElementById('panel-actions').style.display = 'flex';
}

// â”€â”€ Case Finder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runTextSearch() {
  const query = document.getElementById('finder-query').value.trim();
  if (!query) return;

  setFinderStatus('Searchingâ€¦');
  document.getElementById('finder-search-btn').disabled = true;
  document.getElementById('finder-results').innerHTML   = '';

  try {
    const r    = await fetch('/api/search-cases', {
      method:  'POST',
      headers: {'Content-Type': 'application/json'},
      body:    JSON.stringify({ query }),
    });
    const data = await r.json();
    renderFinderResults(data.cases || []);
    setFinderStatus(data.cases?.length ? `${data.cases.length} cases found` : 'No results found.');
  } catch (e) {
    setFinderStatus('Search failed. Please try again.');
  }

  document.getElementById('finder-search-btn').disabled = false;
}

async function handleImageUpload(file, mode) {
  const fd = new FormData();
  fd.append('file', file);

  if (mode === 'finder') {
    setFinderStatus('Analyzing imageâ€¦');
    document.getElementById('finder-results').innerHTML = '';
    try {
      const r    = await fetch('/api/search-by-image', { method: 'POST', body: fd });
      const data = await r.json();
      if (data.description) setFinderStatus(`Image: ${data.description.slice(0, 100)}â€¦`);
      renderFinderResults(data.cases || []);
    } catch (e) {
      setFinderStatus('Image search failed. Please try again.');
    }
  } else {
    // Practice mode: start a case with the best image match
    hideWelcome();
    const loadId = appendLoading('Analyzing image and finding matching caseâ€¦');
    S.busy = true; sendBtn.disabled = true;
    try {
      const r    = await fetch('/api/search-by-image', { method: 'POST', body: fd });
      const data = await r.json();
      removeLoading(loadId);

      if (data.cases && data.cases.length > 0) {
        await startSpecificCase(data.cases[0].id);
      } else {
        appendMsg('ai', 'Could not find a matching case for that image.');
      }
    } catch (e) {
      removeLoading(loadId);
      appendMsg('ai', 'Image upload failed. Please try again.');
    }
    S.busy = false; sendBtn.disabled = false;
  }
}

function renderFinderResults(cases) {
  const el = document.getElementById('finder-results');
  if (!cases.length) {
    el.innerHTML = '<div style="color:#bbb;font-size:0.85rem;font-style:italic;padding:8px 0">No results.</div>';
    return;
  }
  el.innerHTML = cases.map(c => {
    const diff      = (c.difficulty || '').toLowerCase();
    const diffClass = diff.includes('beg') ? 'beginner' : diff.includes('adv') ? 'advanced' : 'intermediate';
    const score     = c.score || 70;
    const patient   = c.patient || {};
    const patInfo   = [patient.age ? `${patient.age}yo` : '', patient.sex || ''].filter(Boolean).join(' ');
    return `
      <div class="case-card">
        <div class="case-card-title">${escHtml(c.title || c.chief_complaint || 'Untitled case')}</div>
        <div class="case-card-tags">
          ${c.specialty ? `<span class="tag specialty">${escHtml(c.specialty)}</span>` : ''}
          ${patInfo     ? `<span class="tag">${escHtml(patInfo)}</span>` : ''}
          ${c.difficulty ? `<span class="tag difficulty-${diffClass}">${escHtml(c.difficulty)}</span>` : ''}
        </div>
        <div class="case-card-complaint">${escHtml(c.chief_complaint || '')}</div>
        <div class="score-bar-wrap">
          <div class="score-bar-track">
            <div class="score-bar-fill" style="width:${score}%"></div>
          </div>
          <div class="score-label">${score}%</div>
        </div>
        <button class="btn-start-case" onclick="startSpecificCase('${escHtml(c.id)}')">
          Start Case â†’
        </button>
      </div>`;
  }).join('');
}

async function startSpecificCase(caseId) {
  setMode('practice');
  hideWelcome();
  const loadId = appendLoading('Starting caseâ€¦');
  S.busy = true; sendBtn.disabled = true;

  try {
    const r    = await fetch('/api/start-case', {
      method:  'POST',
      headers: {'Content-Type': 'application/json'},
      body:    JSON.stringify({ session_id: S.sessionId, case_id: caseId }),
    });
    const data = await r.json();
    removeLoading(loadId);

    S.activeCase = data.case;
    S.revealed   = {};
    S.complete   = false;

    appendMsg('ai', data.response, data.image_url);
    showPanel();
    document.getElementById('panel-actions').style.display = 'flex';
    refreshPanelFromHistory();
  } catch (e) {
    removeLoading(loadId);
    appendMsg('ai', 'Could not start that case. Please try again.');
  }

  S.busy = false; sendBtn.disabled = false;
}

function setFinderStatus(msg) {
  document.getElementById('finder-status').textContent = msg;
}

// â”€â”€ Drag and drop (practice mode â€” whole window) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let dragCounter = 0;

document.addEventListener('dragenter', e => {
  if (S.mode !== 'practice') return;
  if ([...e.dataTransfer.types].includes('Files')) {
    dragCounter++;
    document.getElementById('drag-overlay').classList.add('active');
  }
});

document.addEventListener('dragleave', () => {
  if (S.mode !== 'practice') return;
  dragCounter--;
  if (dragCounter <= 0) {
    dragCounter = 0;
    document.getElementById('drag-overlay').classList.remove('active');
  }
});

document.addEventListener('dragover', e => e.preventDefault());

document.addEventListener('drop', e => {
  e.preventDefault();
  dragCounter = 0;
  document.getElementById('drag-overlay').classList.remove('active');
  if (S.mode !== 'practice') return;
  const file = e.dataTransfer.files[0];
  if (file && file.type.startsWith('image/')) handleImageUpload(file, 'practice');
});

// Finder dropzone drag events
const finderDz = document.getElementById('finder-dropzone');
finderDz.addEventListener('dragover', e => { e.preventDefault(); finderDz.classList.add('drag-over'); });
finderDz.addEventListener('dragleave', () => finderDz.classList.remove('drag-over'));
finderDz.addEventListener('drop', e => {
  e.preventDefault();
  finderDz.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file && file.type.startsWith('image/')) handleImageUpload(file, 'finder');
});

// â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(s) {
  return (s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
</script>
</body>
</html>
